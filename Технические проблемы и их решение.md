---
draft: true
---

## Техническая организация сайта

1. Используя nextcloud все файлы заливаются в папку /usr/local/nextcloud/data/Vidyaranya/files/advayta.org на сервере
2. сервер раз в 5 минут сравнивает хеш содержимого с предыдущим хешем и если он не совпадает то запускает процедуру обновления
3. Для обновления используется докер образ localhost/webdeveloppro/tabs-yarn:latest который содержит в себе код vitepress для рендера страниц
4. после того как докер сбилдил html страницы, wrangler загружает html,css,js файлы в cloudflare pages tab-advayta-org к которому привязан поддомен pages2.advayta.org
5. после загрузки html страниц запускается скрипт для инвалидации кеша со стороны cloudflare

### Как обновить докер образ?
На сервере папка /root/pages єто код сайта на vitepress, после обновления кода нужно выполнить комманду ./make.sh docker-update которая обновит докер образ. Имейте ввиду что всегда используется локальный образ - `localhost/`webdeveloppro/tabs-yarn:latest поєтому обновлять нужно исключительно на сервере, либо внести изменения в файл `force.sh` и `check.sh`

### Как именно сервер мониторит новый контент
- каждые 5ть минут вызывается файл `/root/updater/check.sh` который формирует хеш по содержанию всех файлов и сверяет текущий хеш с хешем который был 5ть минут назад
- если хеш не совпадает то запускается процесс билда и обновления

### Как запустить обновление руками
- зайти на сервер по `ssh`
- перейти в папку `/root/updater`
- запустить файл `./force.sh` - он запустит обновления без проверки хеша

## Сайт не обновляется

В случае если на сайте не появляется новая информация то єто может быть по двум причинам:
- сломана верстка файлов, те в каком-то файле есть недопустимый символ, сломан заголовок файла (то что находиться между --- --- в самом начале) или в названиии файла есть недопустимые символы, такие как: `.,?&^%$#@!*`
- в файле есть ссылка на картинку с не верным адресом. Обсидиан по умолчанию загружает файлы без слеша в начале и из-за єтого при билде к файлу проставляется не верный путь. [[Работа с контентом|детальна информация]] о оформлении картинок

Как увидить проблему?
- Запустить обновление руками (см выше)
- скрипт `./force.sh` выдаст ошибку

## Сайт странно работает, не обновляется
либо обновляется частично.

В случае если сайт странно работает, часть страниц не возвращают результат (белый єкран) то проблема с кеше cloudflare. [[https://developers.cloudflare.com/cache/how-to/purge-cache/purge-everything/|Инструкция]] по очистике кеша в cloudflare


